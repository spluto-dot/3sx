#include "sf33rd/Source/Game/EFFG6.h"
#include "common.h"
#include "sf33rd/Source/Game/EFFECT.h"
#include "sf33rd/Source/Game/EFFG9.h"
#include "sf33rd/Source/Game/SLOWF.h"
#include "sf33rd/Source/Game/workuser.h"

const s16 effg6_data[230][8] = { { 46, 0, 0, 0, -32, 32, 515, 31 },       { 46, 0, 0, 0, -64, 40, 515, 31 },
                                 { 46, 0, 0, 0, -128, 48, 515, 30 },      { 46, 0, 0, 0, -192, 64, 515, 30 },
                                 { 14, 0, 8, 18, -64, 384, 519, 21 },     { 14, 0, 6, 14, -64, 384, 515, 22 },
                                 { 15, 0, 0, 0, 64, 32, 513, 31 },        { 47, 0, 48, 0, 192, 16, 519, 30 },
                                 { 47, 0, -28, 0, 192, 16, 515, 30 },     { 47, 0, -72, 0, -64, 64, 519, 30 },
                                 { 47, 0, -12, 0, 32, 32, 515, 31 },      { 47, 0, 22, 0, 32, 16, 515, 30 },
                                 { 47, 0, 51, 2, 32, 32, 519, 31 },       { 31, 26, 0, 0, 0, 0, 515, 31 },
                                 { 31, 40, 40, 0, -32, 32, 519, 30 },     { 31, 36, -32, 0, -32, 32, 519, 30 },
                                 { 47, 0, -48, 3, -64, 64, 513, 30 },     { 47, 0, 52, 5, 32, 32, 515, 31 },
                                 { 31, 26, 57, 0, 48, 32, 515, 31 },      { 47, 0, -36, 8, -64, 64, 519, 30 },
                                 { 47, 0, 24, 0, -32, 32, 515, 31 },      { 47, 0, 0, 0, 96, 64, 513, 30 },
                                 { 47, 0, 0, 0, 128, 32, 513, 30 },       { 30, 8, 85, 2, 16, 32, 513, 31 },
                                 { 31, 16, -56, 0, -32, 48, 515, 30 },    { 31, 16, 0, 0, -64, 32, 515, 30 },
                                 { 31, 10, 0, 0, -32, 32, 515, 30 },      { 31, 5, 0, 0, -64, 64, 513, 30 },
                                 { 15, 0, 0, 0, 64, 32, 513, 30 },        { 31, 26, -23, -4, 0, 0, 515, 31 },
                                 { 31, 26, -1, -7, 0, 0, 515, 31 },       { 31, 24, -33, -3, 0, 0, 515, 31 },
                                 { 31, 28, 36, -5, 0, 0, 515, 31 },       { 31, 26, -60, 2, 0, 0, 513, 31 },
                                 { 31, 26, 38, -1, 0, 0, 513, 31 },       { 31, 26, 29, 2, 0, 0, 515, 31 },
                                 { 30, 8, 54, -3, 0, 0, 513, 31 },        { 15, 0, 0, 0, 64, 32, 512, 31 },
                                 { 30, 3, 26, -12, 0, 0, 513, 31 },       { 30, 26, -6, -4, 0, 0, 513, 31 },
                                 { 30, 26, 8, -3, 0, 0, 515, 31 },        { 30, 5, -30, -2, 0, 0, 515, 31 },
                                 { 30, 14, 22, -4, 0, 0, 513, 31 },       { 31, 26, -29, -2, 0, 0, 513, 31 },
                                 { 47, 0, 50, 2, 256, 64, 513, 30 },      { 47, 0, -32, 8, 384, 32, 513, 30 },
                                 { 14, 0, -32, 2, 32, 32, 515, 31 },      { 14, 0, -32, 2, 48, 32, 515, 31 },
                                 { 14, 0, -32, 2, 64, 64, 515, 31 },      { 14, 0, 4, 2, -8, 0, 515, 31 },
                                 { 47, 0, 33, -3, -48, 48, 513, 30 },     { 47, 0, 33, -3, -48, 48, 513, 30 },
                                 { 30, 12, 103, -8, 12, 3, 513, 30 },     { 30, 8, 87, -4, 12, 2, 513, 31 },
                                 { 30, 10, 64, -8, 16, 1, 513, 30 },      { 30, 9, 48, -3, 17, 1, 513, 31 },
                                 { 31, 20, 32, -3, 17, 1, 513, 30 },      { 31, 20, 96, -3, 16, 16, 513, 31 },
                                 { 30, 6, 8, 0, -16, 2, 515, 31 },        { 30, 8, 32, -4, -16, 1, 515, 31 },
                                 { 31, 18, -42, -10, 16, 16, 515, 31 },   { 31, 16, -35, -12, 6, 8, 515, 31 },
                                 { 31, 18, -8, -9, -16, 16, 515, 31 },    { 31, 18, -4, -8, -8, 8, 515, 31 },
                                 { 31, 16, -64, 4, -8, 3, 513, 31 },      { 31, 20, 32, 0, -16, 0, 513, 30 },
                                 { 31, 18, -45, -2, 16, 16, 515, 31 },    { 31, 16, -38, -3, 6, 8, 515, 31 },
                                 { 31, 14, -18, -3, 2, 6, 515, 31 },      { 31, 18, 20, -11, -16, 16, 515, 31 },
                                 { 31, 16, 33, -12, -12, 8, 515, 31 },    { 31, 18, -45, -2, 16, 16, 519, 31 },
                                 { 31, 16, -38, -3, 6, 8, 519, 31 },      { 31, 14, -18, -3, 2, 6, 519, 31 },
                                 { 31, 18, 20, -11, -16, 16, 519, 31 },   { 31, 16, 33, -12, -12, 8, 519, 31 },
                                 { 31, 18, 10, 8, 16, 4, 515, 31 },       { 31, 22, 100, 1, 16, 16, 513, 30 },
                                 { 31, 20, -47, -3, 16, 4, 515, 31 },     { 31, 18, 64, -4, 16, 16, 515, 31 },
                                 { 31, 12, 0, 0, -3, 8, 513, 30 },        { 31, 12, -20, 0, -2, 16, 513, 30 },
                                 { 31, 10, -44, 0, -160, 16, 513, 31 },   { 31, 12, -31, 2, -32, 16, 515, 30 },
                                 { 31, 18, 33, -10, -36, 12, 513, 30 },   { 30, 20, -8, 0, 0, 128, 513, 30 },
                                 { 30, 20, 16, 0, 0, 128, 513, 30 },      { 30, 20, -18, 0, 128, 96, 513, 31 },
                                 { 30, 20, 16, 0, -128, 96, 513, 31 },    { 30, 8, 20, 2, -4, 2, 515, 31 },
                                 { 30, 20, 40, -3, -3, 0, 519, 31 },      { 31, 12, -16, 1, 0, 2, 513, 30 },
                                 { 30, 6, 8, 0, -32, 1, 513, 30 },        { 30, 8, 18, 0, -64, 4, 513, 31 },
                                 { 30, 8, -18, 0, 64, 4, 513, 31 },       { 30, 6, -40, -5, 16, 1, 513, 31 },
                                 { 30, 5, -44, -8, 17, 64, 515, 31 },     { 30, 7, -28, 5, -16, 1, 513, 31 },
                                 { 30, 5, -34, 6, -17, 64, 515, 31 },     { 30, 6, 3, -2, 8, 32, 515, 30 },
                                 { 30, 8, 5, -3, 4, 24, 515, 31 },        { 30, 7, 3, -2, 8, 32, 515, 30 },
                                 { 30, 8, 5, -3, 4, 24, 515, 31 },        { 30, 10, 3, -2, 8, 32, 515, 30 },
                                 { 30, 11, 5, -3, 4, 24, 515, 31 },       { 30, 8, 14, -2, -32, 0, 515, 31 },
                                 { 30, 8, 30, 0, -16, 0, 515, 30 },       { 31, 8, -36, 4, -48, 48, 519, 31 },
                                 { 31, 8, 24, 0, -32, 32, 515, 31 },      { 14, 6, 19, 0, -6, 0, 515, 31 },
                                 { 31, 18, -24, -3, 4, 6, 515, 31 },      { 31, 16, 29, -6, 2, 8, 515, 31 },
                                 { 31, 15, 40, 0, 4, 0, 515, 31 },        { 31, 8, 66, -6, -64, 96, 519, 31 },
                                 { 31, 12, -30, -4, -256, 128, 515, 31 }, { 31, 10, -62, -6, 64, 256, 513, 30 },
                                 { 31, 8, 40, -4, -96, 96, 519, 31 },     { 31, 12, -48, 0, -192, 64, 515, 31 },
                                 { 31, 8, 61, -7, 4, 16, 515, 31 },       { 31, 8, 70, -3, 6, 12, 515, 31 },
                                 { 31, 8, 81, 8, 8, 8, 515, 31 },         { 31, 8, 96, 21, 12, 12, 515, 31 },
                                 { 31, 8, 98, 37, 16, -8, 515, 31 },      { 31, 7, 92, 60, -4, -16, 515, 31 },
                                 { 31, 6, 85, 71, -8, -18, 515, 31 },     { 31, 5, 69, 84, -16, -16, 515, 31 },
                                 { 30, 5, -28, 4, -8, 4, 515, 31 },       { 30, 5, -6, 11, -8, 4, 515, 31 },
                                 { 30, 5, 17, 13, -6, 6, 515, 31 },       { 30, 5, 20, 1, 0, 0, 515, 31 },
                                 { 30, 5, 28, 4, 0, 0, 515, 31 },         { 18, 16, 4, -8, 32, 32, 513, 30 },
                                 { 18, 16, 36, -8, -160, 16, 513, 30 },   { 18, 16, -38, -6, 128, 16, 513, 30 },
                                 { 31, 8, 33, -3, -48, 48, 513, 30 },     { 31, 12, -32, 2, 64, 96, 515, 31 },
                                 { 31, 12, 32, -6, 256, 128, 515, 31 },   { 31, 16, 65, 3, 16, 4, 513, 30 },
                                 { 31, 14, 100, 1, 16, 16, 513, 30 },     { 31, 20, 24, -3, 16, 4, 515, 30 },
                                 { 30, 5, -97, -4, -32, 0, 513, 30 },     { 30, 7, -85, -5, 0, 0, 513, 30 },
                                 { 30, 8, -74, -3, 32, 0, 513, 30 },      { 63, 7, 4, -4, -32, 0, 513, 31 },
                                 { 63, 5, 20, -3, 32, 0, 513, 31 },       { 63, 7, -65, -2, -32, 32, 513, 30 },
                                 { 63, 7, -57, -3, -24, 16, 513, 31 },    { 63, 8, -71, -3, -24, 0, 513, 31 },
                                 { 62, 14, -71, -3, -24, 0, 513, 31 },    { 62, 14, -71, -3, -24, 0, 513, 31 },
                                 { 62, 14, -71, -3, -24, 0, 513, 31 },    { 30, 8, -8, 0, 384, 256, 512, 31 },
                                 { 31, 8, -16, 0, 128, 48, 519, 31 },     { 31, 12, -34, 0, 96, 32, 515, 31 },
                                 { 31, 12, -47, -5, 256, 48, 513, 31 },   { 30, 10, 52, 0, 192, 256, 515, 31 },
                                 { 63, 6, -64, -1, -48, 16, 513, 31 },    { 63, 5, -57, -1, -32, 0, 513, 31 },
                                 { 63, 7, -50, -2, -32, 16, 513, 31 },    { 63, 8, -42, -1, -32, 0, 513, 31 },
                                 { 63, 7, -26, -2, -16, 0, 513, 31 },     { 63, 6, -12, 0, -12, 0, 513, 31 },
                                 { 63, 8, 40, -4, -12, 0, 513, 31 },      { 63, 7, 40, -5, -8, 0, 513, 31 },
                                 { 63, 9, -68, -1, -32, 0, 513, 31 },     { 63, 8, -36, -1, -32, 16, 513, 31 },
                                 { 63, 7, -32, -1, -32, 0, 513, 31 },     { 63, 7, -6, 3, -8, 0, 513, 31 },
                                 { 63, 9, 48, -4, -16, 0, 513, 31 },      { 63, 3, -33, -3, 352, 208, 513, 31 },
                                 { 63, 3, -23, -4, 352, 200, 515, 31 },   { 63, 2, -15, -3, 352, 168, 513, 31 },
                                 { 63, 2, -9, -2, 352, 144, 515, 31 },    { 63, 4, -28, -3, 352, 176, 513, 31 },
                                 { 63, 4, -17, -2, 320, 128, 515, 31 },   { 63, 3, -23, -2, 288, 96, 515, 31 },
                                 { 63, 2, -34, -2, 256, 64, 515, 31 },    { 31, 8, 60, -6, -256, 96, 513, 31 },
                                 { 31, 8, -54, -4, -256, 128, 513, 31 },  { 31, 12, 20, 0, -3, 8, 513, 30 },
                                 { 31, 12, 36, 0, -2, 16, 513, 30 },      { 30, 6, -96, 0, -352, 32, 513, 31 },
                                 { 30, 6, -44, 0, -256, 96, 513, 31 },    { 31, 3, 4, -2, -32, 48, 515, 31 },
                                 { 31, 3, 11, -1, -48, 32, 515, 31 },     { 31, 3, 14, -3, 32, 32, 515, 31 },
                                 { 31, 3, 9, -2, 64, 48, 515, 31 },       { 31, 8, 43, 8, 448, 320, 513, 31 },
                                 { 31, 7, 45, 14, 448, 336, 515, 31 },    { 31, 9, 17, 19, 288, 352, 515, 31 },
                                 { 31, 8, 12, 22, 272, 352, 515, 31 },    { 31, 5, 8, -3, 64, 48, 513, 31 },
                                 { 31, 3, 17, -4, 32, 16, 515, 31 },      { 31, 10, -64, 0, -256, 128, 515, 31 },
                                 { 31, 10, -12, -4, -256, 160, 515, 30 }, { 22, 9, -88, -8, -128, 160, 513, 31 },
                                 { 22, 9, -74, -6, -128, 160, 515, 31 },  { 22, 10, -56, -4, -128, 160, 513, 31 },
                                 { 22, 10, -38, -3, -128, 160, 515, 31 }, { 22, 11, -20, -2, -128, 160, 513, 31 },
                                 { 22, 7, -80, -7, -128, 160, 515, 31 },  { 22, 8, -50, -3, -128, 160, 513, 31 },
                                 { 30, 4, 28, 13, 0, 0, 513, 31 },        { 30, 9, 36, 12, 0, 0, 513, 31 },
                                 { 63, 6, -60, -1, -16, 16, 513, 31 },    { 63, 5, -51, -2, -8, 16, 513, 31 },
                                 { 63, 5, -42, -1, 0, 16, 513, 31 },      { 63, 5, -33, 0, 16, 16, 513, 31 },
                                 { 63, 5, -27, 2, 24, 16, 513, 31 },      { 63, 12, -64, 1, -64, 64, 513, 31 },
                                 { 63, 12, 14, 0, -32, 32, 513, 31 },     { 63, 7, -39, -5, -32, 28, 513, 31 },
                                 { 63, 5, -26, -4, -20, 18, 515, 31 },    { 63, 6, -30, -4, -20, 18, 513, 31 },
                                 { 63, 6, -38, -6, -32, 24, 513, 31 },    { 63, 5, -21, -3, -18, 8, 515, 31 },
                                 { 63, 5, -24, -4, -8, 4, 513, 31 },      { 63, 6, -34, -6, -32, 24, 513, 31 },
                                 { 63, 5, -20, -4, -18, 8, 515, 31 },     { 63, 5, -34, -5, -8, 4, 513, 31 },
                                 { 63, 6, -32, -4, -32, 24, 513, 31 },    { 63, 5, -20, -3, -24, 18, 515, 31 },
                                 { 63, 6, -29, -4, -32, 24, 513, 31 },    { 63, 5, -14, -4, -20, 14, 515, 31 },
                                 { 63, 6, -17, -5, -32, 18, 513, 31 },    { 63, 5, -5, -3, -8, 0, 515, 31 },
                                 { 63, 7, -55, -5, -48, 28, 513, 31 },    { 63, 5, -48, -6, -36, 20, 515, 31 },
                                 { 63, 6, -38, -6, -32, 10, 515, 31 },    { 63, 7, -28, -5, 24, 18, 513, 31 } };

void effect_G6_move(WORK_Other *ewk) {
    WORK *mwk = (WORK *)ewk->my_master;

    switch (ewk->wu.routine_no[0]) {
    case 0:
        ewk->wu.routine_no[0] += 1;
        ewk->wu.dmcal_m = effg6_data[ewk->wu.type][0];
        ewk->wu.dir_timer = effg6_data[ewk->wu.type][1];
        ewk->wu.next_x = effg6_data[ewk->wu.type][2];
        ewk->wu.next_y = effg6_data[ewk->wu.type][3];
        ewk->wu.mvxy.a[0].sp = effg6_data[ewk->wu.type][4];
        ewk->wu.mvxy.a[1].sp = effg6_data[ewk->wu.type][5];
        ewk->wu.now_koc = effg6_data[ewk->wu.type][6];
        ewk->wu.direction = effg6_data[ewk->wu.type][7];

        if (ewk->wu.rl_flag) {
            ewk->wu.next_x = -ewk->wu.next_x;
        }

        ewk->wu.mvxy.a[0].sp *= 256;
        ewk->wu.mvxy.a[1].sp *= 256;
        ewk->wu.disp_flag = ewk->wu.now_koc / 256;
        ewk->wu.now_koc &= 0xFF;
        /* fallthrough */

    case 1:
        if (ewk->wu.dead_f == 1) {
            ewk->wu.routine_no[0] += 1;
            return;
        }

        if (((ewk->wu.dmcal_m & 1) && (ewk->wu.old_pos[1] != mwk->xyz[1].disp.pos)) ||
            ((ewk->wu.dmcal_m & 2) && (mwk->disp_flag == 0)) ||
            ((ewk->wu.dmcal_m & 4) && (ewk->wu.dm_vital != mwk->dm_count_up)) ||
            ((ewk->wu.dmcal_m & 8) &&
             ((ewk->wu.old_rno[0] != mwk->routine_no[0]) || (ewk->wu.old_rno[1] != mwk->routine_no[1]) ||
              (ewk->wu.old_rno[2] != mwk->routine_no[2])))) {
        block_22:
            ewk->wu.routine_no[0] += 1;
            return;
        }

        if ((EXE_flag != 0) || (Game_pause != 0)) {
            break;
        }

        if (ewk->wu.dmcal_m & 0x10) {
            if (ewk->wu.dir_timer-- <= 0) {
                goto block_22;
            }
        }

        if (ewk->wu.now_koc & (players_timer + ewk->wu.blink_timing)) {
            break;
        }

        if (ewk->wu.dmcal_m & 0x20) {
            if ((mwk->hit_stop == 0) && (ewk->wu.old_pos[0] == mwk->xyz[0].disp.pos) &&
                (ewk->wu.old_pos[1] == mwk->xyz[1].disp.pos)) {
                goto block_22;
            }
        } else if ((ewk->wu.old_pos[0] == mwk->xyz[0].disp.pos) && (ewk->wu.old_pos[1] == mwk->xyz[1].disp.pos)) {
            break;
        }

        ewk->wu.old_pos[0] = mwk->xyz[0].disp.pos;
        ewk->wu.old_pos[1] = mwk->xyz[1].disp.pos;
        ewk->wu.xyz[0].disp.pos = ewk->wu.old_pos[0] + ewk->wu.next_x;
        ewk->wu.xyz[1].disp.pos = ewk->wu.old_pos[1] + ewk->wu.next_y;
        ewk->wu.position_z = mwk->position_z;
        effect_G9_init(&ewk->wu);
        break;

    case 2:
    default:
        push_effect_work(&ewk->wu);
        break;
    }
}

s32 effect_G6_init(WORK *wk, u8 dat) {
    WORK_Other *ewk;
    s16 ix;

    if ((ix = pull_effect_work(3)) == -1) {
        return -1;
    }

    ewk = (WORK_Other *)frw[ix];
    ewk->wu.be_flag = 1;
    ewk->wu.id = 0xA6;
    ewk->wu.work_id = 0x10;
    ewk->wu.type = dat;
    ewk->wu.rl_flag = wk->rl_flag;
    ewk->wu.my_family = 2;
    ewk->wu.cgromtype = 1;
    ewk->wu.my_col_mode = 0x4200;
    ewk->wu.my_col_code = 0x2020;
    ewk->wu.old_pos[0] = ewk->wu.old_pos[1] = 0;
    ewk->wu.old_rno[0] = wk->routine_no[0];
    ewk->wu.old_rno[1] = wk->routine_no[1];
    ewk->wu.old_rno[2] = wk->routine_no[2];
    ewk->wu.dm_vital = wk->dm_count_up;
    ewk->my_master = (u32 *)wk;
    ewk->master_work_id = wk->work_id;
    ewk->master_id = wk->id;
    ewk->wu.blink_timing = wk->blink_timing;
    return 0;
}
